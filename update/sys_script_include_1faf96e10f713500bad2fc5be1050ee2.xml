<?xml version="1.0" encoding="UTF-8"?>
<record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>public</access>
        <active>true</active>
        <api_name>x_ris_rightscale_c.RightScaleHelper</api_name>
        <client_callable>false</client_callable>
        <description>Set of useful methods</description>
        <name>RightScaleHelper</name>
        <script><![CDATA[var RightScaleHelper = Class.create();
RightScaleHelper.prototype = {
	initialize: function() {
	},
	
	getResourceId: function(links, rel){
		var href = this.getHref(links, rel);
		if (href) {
			return href.match(/\/(\w+)$/)[1];
		}
	},
	
	getHref: function(links, rel){
		if (!rel) rel = 'self';
			for (var i = 0; i < links.length; i++) {
			if (links[i].rel == rel){
				return links[i].href;
			}
		}
	},
	
	capitalizeString: function(string){
		return string.charAt(0).toUpperCase() + string.slice(1);
	},
	
	//decryptValue: function(encryptedValue){
	//	return gs.base64Decode(encryptedValue);
	//},
	
	//encryptValue: function(value){
	//	return gs.base64Encode(value);
	//},
	
	
	parseDateTime: function(dateTime){
		var arr = dateTime.split(/[\- :T+]/); // from your example var date = "2014-05-21T18:37:40+00:00";
		return (new Date(Date.UTC(arr[0], arr[1]-1, arr[2], arr[3], arr[4], arr[5])));
	},
	
	skipUpdate: function(timestamps, lastUpdateAt){
		if (timestamps){
			var updatedAt = this.parseDateTime(timestamps.updated_at);
			// skip saving if record wasn't updated since previous iteration
			if (lastUpdateAt) {
				var lastIterationTime = lastUpdateAt.getNumericValue() - 1*60*1000; //time shift one min
				if (lastIterationTime > updatedAt.getTime()) {
					return true;
				}
			}
		}
	},
	
	logResponse: function(response){
		var responseBody = response.getBody();
		var httpStatus = response.getStatusCode();
		if( httpStatus >= 400 ) {
			gs.error("Response code:" + httpStatus);
			gs.error("Response Body:" + responseBody);
		}
	},
	
	readyForUpdate: function(executedAt, resourceName) {
		var gdt = new GlideDateTime(executedAt);
		var period = ((new Date().getTime()) - gdt.getNumericValue());
		var mins = period / (60*1000);
		var sysProperty = gs.getProperty("x_ris_rightscale_c." + resourceName + "_update_interval");
		var result = (mins % parseInt(sysProperty)) < 1;
		return result;
	},
	
	computeDeploymentsUpdatedAt: function(account){
		if (account.deployments_force_update) {
			// force deployment update
			account.deployments_force_update = false;
			account.update();
			return null;
		}
		var instances_up_at = account.instances_updated_at ? new GlideDateTime(account.instances_updated_at) : null;
		var servers_up_at = account.servers_updated_at ? new GlideDateTime(account.servers_updated_at) : null;
		var server_arrays_up_at = account.server_arrays_updated_at ? new GlideDateTime(account.server_arrays_updated_at) : null;

		var latestUpdatedAt = this.getLatestUpdatedAt(instances_up_at, servers_up_at);
		return this.getLatestUpdatedAt(latestUpdatedAt, server_arrays_up_at);
	},
	
	getLatestUpdatedAt: function(updated_at_1, updated_at_2){
		if (updated_at_1) {
			if (updated_at_2) {
				return updated_at_1.compareTo(updated_at_2) == 1 ? updated_at_1 : updated_at_2;
			}
			return updated_at_1;
		} else {
			return updated_at_2;
		}
	},

	//https://community.servicenow.com/message/738029#738029
	validateJSON: function(text){
		if (/^[\],:{}\s]*$/
			.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g, '@')
		.replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, ']')
		.replace(/(?:^|:|,)(?:\s*\[)+/g, ''))) {
			
			return true;
		}
		return false;
	},
	
	type: 'RightScaleHelper'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2015-01-24 00:53:25</sys_created_on>
        <sys_id>1faf96e10f713500bad2fc5be1050ee2</sys_id>
        <sys_mod_count>56</sys_mod_count>
        <sys_name>RightScaleHelper</sys_name>
        <sys_package display_value="RightScaleCloudManagement" source="x_ris_rightscale_c">adee18db0f61f100bad2fc5be1050e29</sys_package>
        <sys_policy/>
        <sys_scope display_value="RightScaleCloudManagement">adee18db0f61f100bad2fc5be1050e29</sys_scope>
        <sys_update_name>sys_script_include_1faf96e10f713500bad2fc5be1050ee2</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2016-04-06 23:36:53</sys_updated_on>
    </sys_script_include>
</record_update>
